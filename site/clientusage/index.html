
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Carla client - URJC-DeepRacer</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.2afb09e1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#carla-client" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="URJC-DeepRacer" class="md-header__button md-logo" aria-label="URJC-DeepRacer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            URJC-DeepRacer
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Carla client
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="URJC-DeepRacer" class="md-nav__button md-logo" aria-label="URJC-DeepRacer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    URJC-DeepRacer
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../racetrackcreation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Racetrack Creation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../includeracetrackcarla/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Include Racetrack in a CARLA Map
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../createdeepracerinblender/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Create DeepRacer in Blender
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../importdeepracercarla/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Import Deepracer to Carla
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#index" class="md-nav__link">
    <span class="md-ellipsis">
      Index:
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connection-with-server" class="md-nav__link">
    <span class="md-ellipsis">
      Connection with server
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deepracer-camera-settings" class="md-nav__link">
    <span class="md-ellipsis">
      Deepracer Camera Settings
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-time-vs-real-time" class="md-nav__link">
    <span class="md-ellipsis">
      Client time vs real time
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hsv-filter-and-mask-segmentation" class="md-nav__link">
    <span class="md-ellipsis">
      HSV Filter and mask segmentation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HSV Filter and mask segmentation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-color-masks" class="md-nav__link">
    <span class="md-ellipsis">
      Create Color Masks:
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#convert-class-mask-to-rgb-for-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      Convert Class Mask to RGB for Visualization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#generate-dataset" class="md-nav__link">
    <span class="md-ellipsis">
      Generate Dataset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Generate Dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-a-mutex-lock-for-safe-image-access" class="md-nav__link">
    <span class="md-ellipsis">
      Using a Mutex (Lock) for Safe Image Access
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#why-use-a-mutex" class="md-nav__link">
    <span class="md-ellipsis">
      Why Use a Mutex?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lock-setup" class="md-nav__link">
    <span class="md-ellipsis">
      Lock Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#safe-access-in-the-main-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Safe Access in the Main Loop
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="carla-client">Carla client</h1>
<h2 id="index">Index:</h2>
<ul>
<li><a href="#connection-with-server">Connection with server</a></li>
<li><a href="#deepracer-camera-settings">Deepracer Camera settings</a></li>
<li><a href="#client-time-vs-real-time">Client time vs real time</a></li>
<li><a href="#hsv-filter-and-mask-segmentation">HSV Filter and mask segmentation</a></li>
<li><a href="#generate-dataset">Generate Dataset</a></li>
</ul>
<hr />
<video width="1280" height="720" controls>
  <source src="../images/manualcontrol.mp4" type="video/mp4">
</video>
<p>(Map modified as the ramp has been added)</p>
<h2 id="connection-with-server">Connection with server</h2>
<p>Once the package is compressed at the carla root folder:</p>
<pre><code class="language-bash">make package
</code></pre>
<p>Execute </p>
<pre><code>CarlaUE4.sh
</code></pre>
<p>located at :</p>
<pre><code>/Dist/CARLA_Shipping_0.9.15.2-2-gb23c01ae4-dirty/LinuxNoEditor
</code></pre>
<p>Now the server will be available to be connected to. Note that it can be launched with the flag ---RenderOffscreen to make it handier to use later.</p>
<p>Then for the client, you have to create a python file (.py). </p>
<p>We are going to use manualcontrol.py as an example, that will allow us to control the deepracer in the world we have just spawned. We will be using the keys W A S D as input:
-      w: Move forward
-      A: Turn left
-      S: Brake
-      D: Turn right</p>
<p>First, you must import the required modules:</p>
<pre><code class="language-python">import carla
import time
import pygame
import numpy as np
</code></pre>
<ul>
<li>
<p>carla: CARLA client API</p>
</li>
<li>
<p>time: for sleep/wait operations</p>
</li>
<li>
<p>pygame: for keyboard input and display</p>
</li>
<li>
<p>numpy: to process camera image data</p>
</li>
</ul>
<p>Configuration for the CARLA server and the vehicle blueprint.</p>
<pre><code class="language-python">HOST = '127.0.0.1'
PORT = 2000
VEHICLE_MODEL = 'vehicle.finaldeepracer.aws_deepracer'
</code></pre>
<p>Initialize Pygame for displaying the RGB camera feed.</p>
<pre><code class="language-python">pygame.init()
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption(&quot;DeepRacer&quot;)

</code></pre>
<p>Connect to CARLA, set timeout, and load a specific map (Town01).</p>
<pre><code class="language-python">client = carla.Client(HOST, PORT)
client.set_timeout(5.0)
world = client.get_world()
client.load_world('Town01') 

</code></pre>
<p>Set sunny weather with clouds but no rain or fog.</p>
<pre><code class="language-python">weather = carla.WeatherParameters(
    cloudiness=80.0,
    precipitation=0.0,
    sun_altitude_angle=90.0,
    fog_density=0.0,
    wetness=0.0
)
world.set_weather(weather)
</code></pre>
<p>Spawn the DeepRacer Vehicle. Get the blueprint for the AWS DeepRacer vehicle.</p>
<pre><code class="language-python">blueprint_library = world.get_blueprint_library()
vehicle_bp = blueprint_library.find(VEHICLE_MODEL)
</code></pre>
<p>Set vehicle spawn location and attempt to spawn it. If it fails, the program exits.</p>
<pre><code class="language-python">spawn_point = carla.Transform(carla.Location(x=2.95, y=-3.7, z=0.6),
                carla.Rotation(pitch=0, yaw=-90, roll=0))
vehicle = world.try_spawn_actor(vehicle_bp, spawn_point)
</code></pre>
<p>Attach an RGB Camera to the Vehicle.Configure the RGB camera sensor with resolution and field of view.</p>
<pre><code class="language-python">camera_rgb_bp = blueprint_library.find('sensor.camera.rgb')
camera_rgb_bp.set_attribute('image_size_x', str(WIDTH))
camera_rgb_bp.set_attribute('image_size_y', str(HEIGHT))
camera_rgb_bp.set_attribute('fov', '90')
</code></pre>
<p>Place and attach the camera to the vehicle.</p>
<pre><code class="language-python">camera_rgb_transform = carla.Transform(carla.Location(x=-1, z=0.5))
camera_rgb = world.spawn_actor(camera_rgb_bp, camera_rgb_transform, attach_to=vehicle)
</code></pre>
<p>Process RGB Image from Camera.
Convert raw image data into a Pygame surface for display.</p>
<pre><code class="language-python">def process_rgb(image):
    global camera_image_rgb
    array = np.frombuffer(image.raw_data, dtype=np.uint8)
    array = np.reshape(array, (image.height, image.width, 4))[:, :, :3]
    array = array[:, :, ::-1]
    camera_image_rgb = pygame.surfarray.make_surface(array.swapaxes(0, 1))
</code></pre>
<p>Start listening to camera stream and process frames in real time:</p>
<pre><code class="language-python">camera_rgb.listen(lambda image: process_rgb(image))

</code></pre>
<p>Start the control loop and poll the keyboard.</p>
<pre><code class="language-python">control = carla.VehicleControl()
running = True

while running:
    keys = pygame.key.get_pressed()
    if keys[pygame.K_w]: ...
    if keys[pygame.K_a]: ...
    if keys[pygame.K_d]: ...
    if keys[pygame.K_s]: ...
    control.hand_brake = keys[pygame.K_SPACE]
</code></pre>
<p>Apply control values to the vehicle.</p>
<pre><code class="language-python">vehicle.apply_control(control)
</code></pre>
<p>Event Handling and Display</p>
<pre><code class="language-python">for event in pygame.event.get():
        if event.type == pygame.QUIT or (event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE):
            running = False


    if camera_image_rgb:
        screen.blit(camera_image_rgb, (0, 0))

    pygame.display.flip()
</code></pre>
<hr />
<p>Here is the <strong>FULL CODE</strong>: </p>
<pre><code class="language-python">import carla
import time
import pygame
import numpy as np

HOST = '127.0.0.1'
PORT = 2000
VEHICLE_MODEL = 'vehicle.finaldeepracer.aws_deepracer'

pygame.init()
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption(&quot;DeepRacer&quot;)


client = carla.Client(HOST, PORT)
client.set_timeout(5.0)
world = client.get_world()
client.load_world('Town01') 


weather = carla.WeatherParameters(
    cloudiness=80.0,
    precipitation=0.0,
    sun_altitude_angle=90.0,
    fog_density=0.0,
    wetness=0.0
)
world.set_weather(weather)

blueprint_library = world.get_blueprint_library()
vehicle_bp = blueprint_library.find(VEHICLE_MODEL)


spawn_point = carla.Transform(carla.Location(x=2.95, y=-3.7, z=0.6),
                carla.Rotation(pitch=0, yaw=-90, roll=0))

vehicle = world.try_spawn_actor(vehicle_bp, spawn_point)
if not vehicle:
    print(&quot;unable to spanw&quot;)
    exit()
print(f&quot;vehicle {VEHICLE_MODEL} spaned at {spawn_point.location}&quot;)

camera_rgb_bp = blueprint_library.find('sensor.camera.rgb')
camera_rgb_bp.set_attribute('image_size_x', str(WIDTH))
camera_rgb_bp.set_attribute('image_size_y', str(HEIGHT))
camera_rgb_bp.set_attribute('fov', '90')


camera_rgb_transform = carla.Transform(carla.Location(x=-1, z=0.5))
camera_rgb = world.spawn_actor(camera_rgb_bp, camera_rgb_transform, attach_to=vehicle)


camera_image_rgb = None


def process_rgb(image):
    global camera_image_rgb
    array = np.frombuffer(image.raw_data, dtype=np.uint8)
    array = np.reshape(array, (image.height, image.width, 4))[:, :, :3]
    array = array[:, :, ::-1]
    camera_image_rgb = pygame.surfarray.make_surface(array.swapaxes(0, 1))



camera_rgb.listen(lambda image: process_rgb(image))

control = carla.VehicleControl()
running = True

while running:
    keys = pygame.key.get_pressed()

    if keys[pygame.K_w]:
        control.throttle = min(control.throttle + 0.01, 0.8)

    else:
        control.throttle = 0.0


    control.brake = min(control.brake + 0.1, 1.0) if keys[pygame.K_s] else 0.0

    if keys[pygame.K_a]:
        control.steer = max(control.steer - 0.05, -1.0)

    elif keys[pygame.K_d]:
        control.steer = min(control.steer + 0.05, 1.0)

    else:
        control.steer = 0.0

    control.hand_brake = keys[pygame.K_SPACE]

    vehicle.apply_control(control)

    for event in pygame.event.get():
        if event.type == pygame.QUIT or (event.type == pygame.KEYDOWN and event.key == pygame.K_ESCAPE):
            running = False


    if camera_image_rgb:
        screen.blit(camera_image_rgb, (0, 0))

    pygame.display.flip()


camera_rgb.destroy()
vehicle.destroy()
pygame.quit()

</code></pre>
<p>Now execute the code:</p>
<pre><code class="language-bash">python3 manualcontrol.py
</code></pre>
<hr />
<h2 id="deepracer-camera-settings">Deepracer Camera Settings</h2>
<p>To replicate the same camera settings as the actual Deepracer (using the front POV camera). We will need these settings. They represent the location of the camera and its pitch, as it is a bit tilted and facing down.</p>
<pre><code class="language-python">camera_rgb_bp = blueprint_library.find('sensor.camera.rgb')
camera_rgb_bp.set_attribute('image_size_x', str(WIDTH))
camera_rgb_bp.set_attribute('image_size_y', str(HEIGHT))
camera_rgb_bp.set_attribute('fov', '120')


transform_front = carla.Transform(carla.Location(x=0.13, z=0.13), carla.Rotation(pitch=-30))
camera_front = world.spawn_actor(camera_rgb_bp, transform_front, attach_to=vehicle)
</code></pre>
<h2 id="client-time-vs-real-time">Client time vs real time</h2>
<p>When using <strong>synchronous mode</strong> in CARLA, it is <strong>essential to run the simulator with a fixed time-step</strong>.<br />
Otherwise, the physics engine will try to "catch up" for the time the client spent idle, leading to <strong>unrealistic or inconsistent physics</strong>.</p>
<p>What is Fixed Time-Step?</p>
<p>In fixed time-step mode, the simulation advances by the same time increment on every <code>world.tick()</code> call, regardless of how fast your computer is.<br />
To enable this, we must set:</p>
<pre><code class="language-python">settings.synchronous_mode = True
settings.fixed_delta_seconds = 1.0 / 20.0  # 20 FPS
world.apply_settings(settings)
</code></pre>
<p>We want to observe the difference between:</p>
<p>The real time it takes for the computer to perform one simulation step (world.tick()), and</p>
<p>The callback frequency of the camera sensor (e.g. every time it sends an image frame).</p>
<p>We define a camera_callback() function that prints the frame number and timestamp:</p>
<pre><code class="language-python">def camera_callback(image):
    print(f&quot;[Frame {image.frame}] timestamp: {image.timestamp:.5f}&quot;)

</code></pre>
<p>Inside the main loop, we also measure and print the real time gap between ticks:</p>
<pre><code class="language-python">while running:
    t1 = time.time()
    world.tick()
    t2 = time.time()
    print(f&quot;real time gap: {t2 - t1}&quot;)
</code></pre>
<p>We get this output:</p>
<pre><code class="language-bash">real time gap: 0.0028502941131591797
real time gap: 0.0028717517852783203
[Frame 11578] timestamp: 162.86267
real time gap: 0.002864837646484375
[Frame 11579] timestamp: 162.91267
[Frame 11580] timestamp: 162.96267
real time gap: 0.0028464794158935547
[Frame 11581] timestamp: 163.01267
real time gap: 0.002921581268310547
real time gap: 0.0028870105743408203
[Frame 11582] timestamp: 163.06267
[Frame 11583] timestamp: 163.11267
real time gap: 0.0028617382049560547
[Frame 11584] timestamp: 163.16267
real time gap: 0.0031239986419677734
real time gap: 0.0028901100158691406
[Frame 11585] timestamp: 163.21267
[Frame 11586] timestamp: 163.26267
real time gap: 0.0029799938201904297

</code></pre>
<p><strong>Interpretation</strong></p>
<p>Real time gap: 0.0028 means that world.tick() is being executed quickly (~2.8 ms per step) (the computer is fast).</p>
<p>The camera callback prints roughly every 0.05 seconds, confirming it operates at the expected 20 FPS (1 / 20 = 0.05s).</p>
<p>This demonstrates that:</p>
<p>The simulation time advances deterministically by 0.05s per tick.</p>
<p>The real time your PC takes to simulate one frame can be much less than 0.05s.</p>
<p>This difference is expected and is the advantage of running the simulator as fast as possible while maintaining consistent simulation timing.</p>
<p>Here is the code to try this out: </p>
<pre><code class="language-python3">import carla
import time
import pygame
import numpy as np
import matplotlib.pyplot as plt

HOST = '127.0.0.1'
PORT = 2000
VEHICLE_MODEL = 'vehicle.finaldeepracer.aws_deepracer'


pygame.init()
WIDTH, HEIGHT = 800, 600
screen = pygame.display.set_mode((WIDTH, HEIGHT))
pygame.display.set_caption(&quot;DeepRacer - RGB y Segmentación Semántica&quot;)


client = carla.Client(HOST, PORT)
client.set_timeout(5.0)
world = client.get_world()

#FPS
settings = world.get_settings()
settings.synchronous_mode = True
settings.fixed_delta_seconds = 1.0 / 20.0
world.apply_settings(settings)

weather = carla.WeatherParameters(
    cloudiness=80.0,
    precipitation=0.0,
    sun_altitude_angle=90.0,
    fog_density=0.0,
    wetness=0.0
)
world.set_weather(weather)

blueprint_library = world.get_blueprint_library()
vehicle_bp = blueprint_library.find(VEHICLE_MODEL)


spawn_point = carla.Transform(
    carla.Location(x=3, y=-1, z=0.5),
    carla.Rotation(yaw=-90)
)
vehicle = world.try_spawn_actor(vehicle_bp, spawn_point)
if not vehicle:
    print(&quot;Error spawning&quot;)
    exit()


camera_rgb_bp = blueprint_library.find('sensor.camera.rgb')
camera_rgb_bp.set_attribute('image_size_x', str(WIDTH))
camera_rgb_bp.set_attribute('image_size_y', str(HEIGHT))
camera_rgb_bp.set_attribute('fov', '120')


transform_front = carla.Transform(carla.Location(x=0.13, z=0.13), carla.Rotation(pitch=-30))
transform_thirdpers = carla.Transform(carla.Location(x=-1, z=0.75))
camera_front = world.spawn_actor(camera_rgb_bp, transform_front, attach_to=vehicle)


def camera_callback(image):
    print(f&quot;[Frame {image.frame}] timestamp: {image.timestamp:.5f}&quot;)



camera_front.listen(camera_callback)


control = carla.VehicleControl()
running = True

while running:

    # Move on to the next iteration with world.tick()
    t1 = time.time()
    world.tick()
    t2 = time.time()
    print(f&quot;real time gap: {t2-t1}&quot;)


camera_rgb.destroy()
vehicle.destroy()
pygame.quit()
</code></pre>
<h2 id="hsv-filter-and-mask-segmentation">HSV Filter and mask segmentation</h2>
<p><img alt="1" src="../images/segmented.png" /></p>
<p>This section explains how the script processes RGB images from the front camera of the Deepracer in CARLA to create <strong>semantic segmentation masks</strong> based on color, using the HSV color space.
We want to:
- Detect <strong>white</strong> and <strong>yellow</strong> lane markings on the road.
- Classify each pixel into a semantic class:
  - <code>0</code>: background (black)
  - <code>1</code>: white
  - <code>2</code>: yellow
- Save a colorized mask and use it for training or control logic.</p>
<pre><code class="language-python">hsv = cv2.cvtColor(rgb, cv2.COLOR_RGB2HSV)
</code></pre>
<p>The image is converted from RGB to HSV. HSV is preferred for color segmentation because this makes it easier to separate colors like white and yellow.</p>
<h3 id="create-color-masks">Create Color Masks:</h3>
<p><strong>Yellow Mask</strong></p>
<pre><code class="language-python">lower_yellow = np.array([18, 50, 150])
upper_yellow = np.array([40, 255, 255])
mask_yellow = cv2.inRange(hsv, lower_yellow, upper_yellow)
</code></pre>
<p><strong>White Mask</strong></p>
<pre><code class="language-python">lower_white = np.array([0, 0, 200])
upper_white = np.array([180, 30, 255])
mask_white = cv2.inRange(hsv, lower_white, upper_white)
</code></pre>
<p><strong>Create Semantic Class Mask</strong></p>
<p>Initialize a blank mask.</p>
<p>Pixels detected as white are labeled as 1.</p>
<p>Pixels detected as yellow are labeled as 2.</p>
<pre><code class="language-python">mask_class = np.zeros_like(mask_white, dtype=np.uint8)
mask_class[mask_white &gt; 0] = 1
mask_class[mask_yellow &gt; 0] = 2
</code></pre>
<h3 id="convert-class-mask-to-rgb-for-visualization">Convert Class Mask to RGB for Visualization</h3>
<pre><code class="language-python">mask_rgb = np.zeros_like(rgb)
mask_rgb[mask_class == 1] = [255, 255, 255]  # white
mask_rgb[mask_class == 2] = [255, 255, 0]    # yellow

</code></pre>
<p>This gives a visually interpretable image where:</p>
<p>White areas are actual white ([255,255,255])</p>
<p>Yellow areas are yellow ([255,255,0])</p>
<p>Background remains black ([0,0,0])</p>
<p>This mask_rgb is used for display (cv2.imshow) and for dataset generation (cv2.imwrite).</p>
<hr />
<h2 id="generate-dataset">Generate Dataset</h2>
<p>To do so, we launch a script that creates a unique dataset folder based on the current timestamp:</p>
<pre><code class="language-python">currtime = str(int(time.time() * 1000))
DATASET_ID = &quot;Deepracer_BaseMap_&quot; + currtime
</code></pre>
<pre><code class="language-pgsql">dataset/
└── Deepracer_BaseMap_&lt;timestamp&gt;/
    ├── rgb/        ← RGB images from the camera
    ├── masks/      ← Mask images with segmented classes
    └── dataset.csv ← Metadata log
</code></pre>
<p>Each frame is processed and saved using the keep_data() function. </p>
<ul>
<li>
<p>rgb_img is saved as-is.</p>
</li>
<li>
<p>mask_class_img is a colorized version of the class mask:</p>
<ul>
<li>
<p>Pixels labeled 1 (white) become [255, 255, 255]</p>
</li>
<li>
<p>Pixels labeled 2 (yellow) become [255, 255, 0]</p>
</li>
<li>
<p>Background stays black</p>
</li>
</ul>
</li>
</ul>
<pre><code class="language-python">RGB_DIR = os.path.join(DATASET_ID, &quot;rgb&quot;)
MASK_DIR = os.path.join(DATASET_ID, &quot;masks&quot;)
CSV_PATH = os.path.join(DATASET_ID, f&quot;dataset.csv&quot;)

def keep_data(timestamp, rgb_img, mask_class_img, accel, steer, brake, speed, heading):
    ...
    cv2.imwrite(os.path.join(RGB_DIR, rgb_name), rgb_img)
    cv2.imwrite(os.path.join(MASK_DIR, mask_name), cv2.cvtColor(mask_class_img, cv2.COLOR_RGB2BGR))

</code></pre>
<p>Each image is associated with a row in the CSV file:</p>
<pre><code class="language-python">writer.writerow([rgb_path_rel, mask_path_rel, timestamp, accel, steer, brake, speed, heading])

</code></pre>
<ul>
<li>rgb_path  Relative path to the RGB image</li>
<li>mask_path Relative path to the mask image</li>
<li>timestamp Capture time in ms</li>
<li>throttle  Throttle value at capture</li>
<li>steer Steer value at capture</li>
<li>brake Brake value at capture</li>
<li>speed Vehicle speed in m/s</li>
<li>heading   Heading angle in degrees</li>
</ul>
<h3 id="using-a-mutex-lock-for-safe-image-access">Using a Mutex (Lock) for Safe Image Access</h3>
<p>This script uses a <strong>Python mutex (<code>Lock</code>)</strong> to ensure safe access to the camera image data, especially in a <strong>multithreaded context</strong> involving sensor callbacks from CARLA.</p>
<h3 id="why-use-a-mutex">Why Use a Mutex?</h3>
<p>CARLA sensors (like the RGB camera) call a <strong>callback function in a separate thread</strong> every time a new image arrives.<br />
Meanwhile, the main loop (running in another thread) may try to access that image.</p>
<p>Without protection, this leads to <strong>race conditions</strong> where:
- Data may be read while it's being written
- The program may crash or behave inconsistently
- You may process outdated or corrupted frames</p>
<h3 id="lock-setup">Lock Setup</h3>
<pre><code class="language-python">from threading import Lock
from collections import deque

image_queue = deque(maxlen=1)
queue_lock = Lock()
</code></pre>
<ul>
<li>image_queue: stores only the latest image</li>
<li>queue_lock: a mutex to synchronize access to the queue</li>
</ul>
<p>Every time a new image is received, the mutex is acquired with with queue_lock
The queue is cleared (to keep only the latest image)
The new image is appended safely.</p>
<pre><code class="language-python">def camera_callback(image):
    with queue_lock:
        image_queue.clear()
        image_queue.append((int(time.time() * 1000), image))
</code></pre>
<h3 id="safe-access-in-the-main-loop">Safe Access in the Main Loop</h3>
<p>The main loop locks the queue before accessing it
If the image is too old (over 150 ms), it is discarded
This avoids race conditions with the callback</p>
<pre><code class="language-python">with queue_lock:
    if image_queue:
        img_timestamp, image = image_queue[0]
        age = int(time.time() * 1000) - img_timestamp
        if age &lt;= MAX_IMAGE_AGE_MS:
            image = image_queue.popleft()[1]
        else:
            image = None  # Image too old, discard
    else:
        image = None

</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>